#!/bin/zsh -eu

#
# Update all the things.
#

# Update Chrome, sync other apps
open -a "Google Chrome" chrome://settings/help
open -a messages
open -a notes

# MacOS software
echo "Updating MacOS software (requires privs)"
sudo softwareupdate --all --install --force --verbose --restart
sudo --remove-timestamp  # Delete cached credentials

# Brew
brew doctor
brew update
brew upgrade

# All of the git repos in my user dir
for repo in $( find ~ -name ".git" -type d -prune ) ; do
  R=$( dirname $repo )
  echo
  echo $R
  echo
  cd $R

  # Ignore repositories that do not have a remote.
  REMOTE=$( git remote -v )
  if [[ "${REMOTE}" != "" ]] ; then
    git pull
  fi

  # Update any Golang modules.
  if [[ -f go.mod ]] ; then
    ~/bin/macos/golang-modup
    make test
    # Make the changes (if any) permanent
    (git add go.mod go.sum && git commit -m 'Update to latest modules' && git push) || true
  fi

  cd
  echo
done
